<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 6: More About Integer Arithmetic – C404: Assembly Language</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/fmsi.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">C404: Assembly Language</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lectures" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lectures</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lectures">    
        <li>
    <a class="dropdown-item" href="../lectures/lec01.html">
 <span class="dropdown-text">Lecture 1: Basic Concepts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lec02.html">
 <span class="dropdown-text">Lecture 2: Assembly Language Fundamentals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lec03.html">
 <span class="dropdown-text">Lecture 3: Binary Arithmetic, Logic and Addressing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lec04.html">
 <span class="dropdown-text">Lecture 4: Branching and Looping</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lec05.html">
 <span class="dropdown-text">Lecture 5: Procedures</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-exercises" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-exercises">    
        <li>
    <a class="dropdown-item" href="../exercises/inclass01.html">
 <span class="dropdown-text">Exercise 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../exercises/inclass02.html">
 <span class="dropdown-text">Exercise 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../exercises/inclass03.html">
 <span class="dropdown-text">Exercise 3</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <div id="quarto-announcement" data-announcement-id="f05b4cca1daa1827a0cc784371537e32" class="alert alert-primary hidden"><i class="bi bi-telegram quarto-announcement-icon"></i><div class="quarto-announcement-content">
<p>Please join the course group at <a href="https://t.me/+PE3cTMyrv5s3OGI0">FMSI-CS404-ASSEMBLY</a>; Telegram Group</p>
</div><i class="bi bi-x-lg quarto-announcement-action"></i></div>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#objectives" id="toc-objectives" class="nav-link active" data-scroll-target="#objectives">Objectives:</a></li>
  <li><a href="#shifting-and-rotation" id="toc-shifting-and-rotation" class="nav-link" data-scroll-target="#shifting-and-rotation">Shifting and Rotation</a>
  <ul class="collapse">
  <li><a href="#logical-and-arithmetic-shifts" id="toc-logical-and-arithmetic-shifts" class="nav-link" data-scroll-target="#logical-and-arithmetic-shifts">Logical and Arithmetic Shifts</a></li>
  <li><a href="#rotations" id="toc-rotations" class="nav-link" data-scroll-target="#rotations">Rotations</a></li>
  <li><a href="#multi-precision-shifts" id="toc-multi-precision-shifts" class="nav-link" data-scroll-target="#multi-precision-shifts">Multi-precision Shifts</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a></li>
  <li><a href="#shift-and-rotate-applications" id="toc-shift-and-rotate-applications" class="nav-link" data-scroll-target="#shift-and-rotate-applications">Shift and Rotate Applications</a></li>
  </ul></li>
  <li><a href="#extended-addition-and-subtraction" id="toc-extended-addition-and-subtraction" class="nav-link" data-scroll-target="#extended-addition-and-subtraction">Extended Addition and Subtraction</a>
  <ul class="collapse">
  <li><a href="#adc-instruction" id="toc-adc-instruction" class="nav-link" data-scroll-target="#adc-instruction"><code>ADC</code> Instruction</a></li>
  <li><a href="#sbb-instruction" id="toc-sbb-instruction" class="nav-link" data-scroll-target="#sbb-instruction"><code>SBB</code> Instruction</a></li>
  <li><a href="#flags-affected-3" id="toc-flags-affected-3" class="nav-link" data-scroll-target="#flags-affected-3">Flags Affected</a></li>
  <li><a href="#examples-1" id="toc-examples-1" class="nav-link" data-scroll-target="#examples-1">Examples</a></li>
  </ul></li>
  <li><a href="#unpacked-and-packed-decimal-arithmetic" id="toc-unpacked-and-packed-decimal-arithmetic" class="nav-link" data-scroll-target="#unpacked-and-packed-decimal-arithmetic">Unpacked and Packed Decimal Arithmetic</a>
  <ul class="collapse">
  <li><a href="#aaa-instruction" id="toc-aaa-instruction" class="nav-link" data-scroll-target="#aaa-instruction"><code>AAA</code> Instruction</a></li>
  <li><a href="#daa-instruction" id="toc-daa-instruction" class="nav-link" data-scroll-target="#daa-instruction"><code>DAA</code> Instruction</a></li>
  <li><a href="#aas-instruction" id="toc-aas-instruction" class="nav-link" data-scroll-target="#aas-instruction"><code>AAS</code> Instruction</a></li>
  <li><a href="#das-instruction" id="toc-das-instruction" class="nav-link" data-scroll-target="#das-instruction"><code>DAS</code> Instruction</a></li>
  <li><a href="#aam-instruction" id="toc-aam-instruction" class="nav-link" data-scroll-target="#aam-instruction"><code>AAM</code> Instruction</a></li>
  <li><a href="#aad-instruction" id="toc-aad-instruction" class="nav-link" data-scroll-target="#aad-instruction"><code>AAD</code> Instruction</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="lec06.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 6: More About Integer Arithmetic</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- 
1. Shift and Rotate
2. Extended addition and subtraction (section 7.4)
3. Unpacked decimal
4. Packed decimal
5. String operations 9.1, 9.2, and 9.3
6. Advanced Procedure 
7. FPU
-->
<section id="objectives" class="level2">
<h2 class="anchored" data-anchor-id="objectives">Objectives:</h2>
<p>In this lecture, you will learn how to perform:</p>
<ol type="1">
<li>Shifting and rotation</li>
<li>Extended addition and subtraction</li>
<li>Binary-Coded Decimal operations.</li>
</ol>
</section>
<section id="shifting-and-rotation" class="level2">
<h2 class="anchored" data-anchor-id="shifting-and-rotation">Shifting and Rotation</h2>
<ul>
<li><p>Bit shifting means to move bits right and left inside an operand.</p></li>
<li><p>x86 architecture provides a rich set of instruction in this area.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Instruction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SHL</td>
<td>Shift (logic) left</td>
</tr>
<tr class="even">
<td>SHR</td>
<td>Shift (Logic) right</td>
</tr>
<tr class="odd">
<td>SAL</td>
<td>Shift arithmetic left</td>
</tr>
<tr class="even">
<td>SAR</td>
<td>Shift arithmetic right</td>
</tr>
<tr class="odd">
<td>ROL</td>
<td>Rotate left</td>
</tr>
<tr class="even">
<td>ROR</td>
<td>Rotate right</td>
</tr>
<tr class="odd">
<td>RCL</td>
<td>Rotate through carry left</td>
</tr>
<tr class="even">
<td>RCR</td>
<td>Rotate through carry right</td>
</tr>
<tr class="odd">
<td>SHLD</td>
<td>Double-precision shift left</td>
</tr>
<tr class="even">
<td>SHRD</td>
<td>Double-precision shift right</td>
</tr>
</tbody>
</table></li>
</ul>
<section id="logical-and-arithmetic-shifts" class="level3">
<h3 class="anchored" data-anchor-id="logical-and-arithmetic-shifts">Logical and Arithmetic Shifts</h3>
<div class="callout callout-style-simple callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Syntax
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb1" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SHL</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SHR</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SAL</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SAR</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Rules
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>The destination operand can be either register or memory location</p></li>
<li><p>The count operand can be either:</p>
<ol type="1">
<li><p>CL register</p></li>
<li><p>immediate (of size 8-bit)</p></li>
<li><p>1</p></li>
</ol></li>
</ul>
</div>
</div>
<ul>
<li>Therefore, the valid forms are:</li>
</ul>
<pre data-code-line-numbers=""><code>      SHL   reg/mem, imm8
      SHL   reg/mem, CL
      SHL   reg/mem, 1</code></pre>
<ul>
<li><p>The form <code>SHL  reg/mem, 1</code> has its own,optimized op-codes in x86 architecture.</p></li>
<li><p>The count is masked to 5 bits (or 6 bits with a 64-bit operand). The count range is limited to 0 to 31 (or 63 with a 64-bit operand).</p></li>
</ul>
<section id="logical-shifts-using-shl-and-shr-instructions" class="level4">
<h4 class="anchored" data-anchor-id="logical-shifts-using-shl-and-shr-instructions">Logical Shifts using <code>SHL</code> and <code>SHR</code> instructions</h4>
<ul>
<li><p>If you treat the destination operand as unsigned integer, then use logical shifts.</p></li>
<li><p><code>SHL</code> and <code>SHR</code> instructions shift the bits of the destination operand to the left (toward most significant bit locations) and right (toward less significant bit locations), respectively.</p></li>
<li><p>For each shift count to the right, the least significant bit of the destination operand is shifted into the <code>CF</code> flag, and the most significant bit is cleared. See <a href="#fig-shiftlogic" class="quarto-xref">Figure&nbsp;1</a> (a).</p></li>
<li><p>For each shift count to the left, the most significant bit of the destination operand is shifted into the CF flag, and the least significant bit is cleared. See <a href="#fig-shiftlogic" class="quarto-xref">Figure&nbsp;1</a> (b).</p>
<div id="fig-shiftlogic" class="quarto-float quarto-figure quarto-figure-center anchored" width="70%">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shiftlogic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/shiftlogic.png" id="fig-shiftlogic" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-shiftlogic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1
</figcaption>
</figure>
</div></li>
</ul>
</section>
<section id="arithmetic-shifts-using-sal-and-sar-instructions" class="level4">
<h4 class="anchored" data-anchor-id="arithmetic-shifts-using-sal-and-sar-instructions">Arithmetic Shifts using <code>SAL</code> and <code>SAR</code> instructions</h4>
<ul>
<li><p>If you treat the destination operand as signed integer, then use arithmetic shifts.</p></li>
<li><p>For each shift count to the right, the least significant bit of the destination operand is shifted into the <code>CF</code> flag, and the most significant bit is set or cleared according to the sign of the original value. See <a href="#fig-shiftarithmetic" class="quarto-xref">Figure&nbsp;2</a> (a).</p></li>
<li><p>For each shift count to the left, the most significant bit of the destination operand is shifted into the CF flag, and the least significant bit is cleared. See <a href="#fig-shiftarithmetic" class="quarto-xref">Figure&nbsp;2</a> (b).</p>
<div id="fig-shiftarithmetic" class="quarto-float quarto-figure quarto-figure-center anchored" width="70%">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shiftarithmetic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/shiftarithmetic.png" id="fig-shiftarithmetic" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-shiftarithmetic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2
</figcaption>
</figure>
</div></li>
<li><p>Notice that there is no difference between <code>SHL</code> and <code>SAL</code>. Eventually, they have the same op-code.</p></li>
</ul>
</section>
<section id="flags-affected" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected">Flags Affected</h4>
<ul>
<li><p>The <code>CF</code> flag contains the value of the last bit shifted out of the destination operand.</p></li>
<li><p>The <code>OF</code> flag is affected only on 1-bit shifts.</p>
<ul>
<li><p>For left shifts, the <code>OF</code> flag is set to 0 if the most-significant bit of the result is the same as the <code>CF</code> flag (that is, the top two bits of the original operand were the same); otherwise, it is set to 1.</p></li>
<li><p>For the <code>SAR</code> instruction, the <code>OF</code> flag is cleared for all 1-bit shifts.</p></li>
<li><p>For the <code>SHR</code> instruction, the OF flag is set to the most-significant bit of the original operand.</p></li>
</ul></li>
<li><p>The <code>SF</code>, <code>ZF</code>, and <code>PF</code> flags are set according to the result.</p></li>
<li><p>The <code>AF</code> flag is undefined.</p></li>
<li><p>If the count is 0, the flags are not affected.</p></li>
</ul>
</section>
</section>
<section id="rotations" class="level3">
<h3 class="anchored" data-anchor-id="rotations">Rotations</h3>
<div class="callout callout-style-simple callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Syntax
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb3" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ROL</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ROR</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">RCL</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">RCR</span>     <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>The rotation instructions have the same rule as in shift instructions.</li>
<li>The rotate left (<code>ROL</code>) and rotate through carry left (<code>RCL</code>) instructions shift ALL bits toward more-significant bit positions, except for the most-significant bit, which is rotated to the least-significant bit location.</li>
<li>The rotate right (<code>ROR</code>) and rotate through carry right (<code>RCR</code>) instructions shift all the bits toward less significant bit positions, except for the least-significant bit, which is rotated to the most-significant bit location.</li>
</ul>
<section id="rotations-using-rol-and-ror-instructions" class="level4">
<h4 class="anchored" data-anchor-id="rotations-using-rol-and-ror-instructions">Rotations using <code>ROL</code> and <code>ROR</code> instructions</h4>
<p><a href="#fig-rotate" class="quarto-xref">Figure&nbsp;3</a> illustrates one-round of bits shifting. It shows that the bit shifted into <code>CF</code> is copied to the least or most significant bit (according to the shift direction).</p>
<div id="fig-rotate" class="quarto-float quarto-figure quarto-figure-center anchored" width="70%">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rotate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/rotate.png" id="fig-rotate" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rotate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3
</figcaption>
</figure>
</div>
</section>
<section id="rotations-through-carry-using-rcl-and-rcr" class="level4">
<h4 class="anchored" data-anchor-id="rotations-through-carry-using-rcl-and-rcr">Rotations through carry using RCL and RCR</h4>
<p><a href="#fig-rotatecarry" class="quarto-xref">Figure&nbsp;4</a> illustrates the rotation through <code>CF</code> flag. If the direction of shifting is to the right, the <code>CF</code> is acting as least significant bit. If the direction of shifting is to the left, the <code>CF</code> is acting as most significant bit.</p>
<div id="fig-rotatecarry" class="quarto-float quarto-figure quarto-figure-center anchored" width="70%">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rotatecarry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/rotatecarry.png" id="fig-rotatecarry" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rotatecarry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4
</figcaption>
</figure>
</div>
</section>
<section id="flags-affected-1" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-1">Flags Affected</h4>
<ul>
<li><p>The <code>CF</code> flag contains the value of the last bit shifted out of the destination operand.</p></li>
<li><p>The OF flag is defined only for 1-bit rotates:</p>
<ul>
<li><p>For left rotates, the OF flag is set to the exclusive OR of the CF bit (after the rotate) and the most-significant bit of the result.</p></li>
<li><p>For right rotates, the OF is set to the exclusive OR of the two most-significant bits of the result.</p></li>
</ul></li>
<li><p>If count is 0, all flags are not affected.</p></li>
<li><p>The SF, ZF, AF, PF flags are always undefined.</p></li>
</ul>
</section>
</section>
<section id="multi-precision-shifts" class="level3">
<h3 class="anchored" data-anchor-id="multi-precision-shifts">Multi-precision Shifts</h3>
<div class="callout callout-style-simple callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Syntax
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb4" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SHLD</span>    <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>source<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SHRD</span>    <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>source<span class="op">&gt;,</span> <span class="op">&lt;</span>count<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Rules
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>The destination operand can be a register or a memory location of size word or doubleword.</p></li>
<li><p>The source operand must be a register</p></li>
<li><p>The destination and source operands must be of the same size.</p></li>
<li><p>The count operand can be unsigned immediate byte or CL register.</p></li>
<li><p>In 32-bit, the count value should be between 0 and 31.</p></li>
</ul>
</div>
</div>
<ul>
<li><p>According to the rules above, the valid forms are:</p>
<pre data-code-line-numbers=""><code>      SHLD    reg/mem16, 1
      SHLD    reg/mem16, CL
      SHLD    reg/mem16, imm8
      SHLD    reg/mem32, 1
      SHLD    reg/mem32, CL
      SHLD    reg/mem32, imm8</code></pre></li>
<li><p>The <code>SHLD</code> instruction shifts the first operand (destination operand) to the left the number of bits specified by the count operand. The empty bit positions opened up by the shift are filled by the most significant bits of the source operand.</p></li>
<li><p>Similarly, the <code>SHRD</code> instruction shifts the destination operand to the right, and the empty bit positions are filled by the least significant bits of the source operand.</p></li>
<li><p><a href="#fig-doubleshiftmov" class="quarto-xref">Figure&nbsp;5</a> illustrates the movement of shifted bits from the source operand to the destination operand to the CF flag.</p>
<div id="fig-doubleshiftmov" class="quarto-float quarto-figure quarto-figure-center anchored" width="620">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-doubleshiftmov-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/shiftdoublemov.png" id="fig-doubleshiftmov" class="img-fluid figure-img" width="620">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-doubleshiftmov-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5
</figcaption>
</figure>
</div></li>
<li><p><a href="#fig-doubleshift" class="quarto-xref">Figure&nbsp;6</a> shows the exact bits that will shifted and moved from the source operand to destination operand when they are 32-bit.</p>
<div id="fig-doubleshift" class="quarto-float quarto-figure quarto-figure-center anchored" width="70%">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-doubleshift-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/double_shift.png" id="fig-doubleshift" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-doubleshift-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6
</figcaption>
</figure>
</div></li>
</ul>
<section id="flags-affected-2" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-2">Flags Affected</h4>
<ul>
<li><p>The <code>CF</code> flag contains the value of the last bit shifted out of the destination operand.</p></li>
<li><p>The <code>OF</code> flag is affected only on 1-bit shifts, the <code>OF</code> flag is set if a sign change occurred; otherwise, it is cleared.</p></li>
<li><p>The <code>SF</code>, <code>ZF</code>, and <code>PF</code> flags are set according to the result.</p></li>
<li><p>The <code>AF</code> flag is undefined.</p></li>
<li><p>If the count is 0, the flags are not affected. If the count is greater than the operand size, the flags are undefined.</p></li>
</ul>
</section>
</section>
<section id="examples" class="level3">
<h3 class="anchored" data-anchor-id="examples">Examples</h3>
<div id="exm-01" class="theorem example">
<p><span class="theorem-title"><strong>Example 1</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb6" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">8</span><span class="er">Fh</span>     <span class="co">; BL= 1000 1111b</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">shl</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; BL= 0001 1110b, CF=1, OF=1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">8</span><span class="er">Fh</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sal</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">2</span>       <span class="co">; BL= 0011 1100b, CF=0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-02" class="theorem example">
<p><span class="theorem-title"><strong>Example 2</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb7" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span><span class="bn">D</span><span class="er">7h</span>    <span class="co">; AL= 1101 0111b</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">shr</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">2</span>       <span class="co">; AL= 0011 0101b, CF=1</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span><span class="bn">D</span><span class="er">7h</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">sar</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">2</span>       <span class="co">; AL= 1111 0101b, CF=1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-03" class="theorem example">
<p><span class="theorem-title"><strong>Example 3</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb8" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span><span class="er">C0h</span>    <span class="co">; AL= 1100 0000b</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rol</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; AL= 1000 0001b, CF=1</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rol</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; AL= 0000 0011b, CF=1</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rol</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; AL= 0000 0110b, CF=0</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="bn">26h</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rol</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">4</span>       <span class="co">; AL= 62h</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-04" class="theorem example">
<p><span class="theorem-title"><strong>Example 4</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb9" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">clc</span>               <span class="co">; Clear CF (CF=0)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">bl</span><span class="op">,</span> <span class="bn">88h</span>     <span class="co">; BL= 1000 1000b</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rcl</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; BL= 0001 0000b, CF = 1</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rcl</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; BL= 0010 0001b, CF = 0</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-05" class="theorem example">
<p><span class="theorem-title"><strong>Example 5</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb10" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stc</span>               <span class="co">; Set CF (CF=1)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">ah</span><span class="op">,</span> <span class="bn">10h</span>     <span class="co">; AL= 0001 0000b</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rcr</span>   <span class="kw">ah</span><span class="op">,</span> <span class="dv">1</span>       <span class="co">; AL= 1000 1000b, CF=0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-06" class="theorem example">
<p><span class="theorem-title"><strong>Example 6</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb11" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">ax</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">bx</span><span class="op">,</span> <span class="bn">1234h</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">shld</span>  <span class="kw">ax</span><span class="op">,</span> <span class="kw">bx</span><span class="op">,</span> <span class="dv">4</span>   <span class="co">; AX=0001h, BX=1234h, CF=1</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mov</span>   <span class="kw">ax</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">shrd</span>  a<span class="op">,</span> <span class="kw">bx</span><span class="op">,</span> <span class="dv">4</span>    <span class="co">; AX=4000h, BX=1234h, CF=0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="shift-and-rotate-applications" class="level3">
<h3 class="anchored" data-anchor-id="shift-and-rotate-applications">Shift and Rotate Applications</h3>
<ol type="1">
<li><p>The <code>SHL</code> and <code>SAL</code> instructions perform unsigned and signed multiplication when the multiplier is a power of 2. Shifting an integer <span class="math inline">\(n\)</span> bits to the left multiplies it by <span class="math inline">\(2^n\)</span> .</p></li>
<li><p>The <code>SHR</code> and <code>SAR</code> instructions can be used to perform unsigned or signed division, respectively, of the destination operand by power of 2.</p>
<ul>
<li>Using the <code>SAR</code> instruction to perform a division operation does not produce the same result as the <code>IDIV</code> instruction. The quotient from the <code>IDIV</code> instruction is rounded toward zero, whereas the “quotient” of the <code>SAR</code> instruction is rounded toward negative infinity.</li>
</ul></li>
<li><p>The shift instructions can be used to extract data (field value) from a <strong>bit string</strong>.</p>
<ul>
<li><p>For example, the first word of the Internet Protocol (IP) header has three fields: version, header length, and type of service, as shown below.</p>
<div id="fig-ipheader" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ipheader-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/ipheader.png" id="fig-ipheader" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-ipheader-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7
</figcaption>
</figure>
</div></li>
<li><p>Assume this word has been read and stored in <code>AX</code> register.</p></li>
<li><p>Then, we can extract <code>version</code> by masking off bits from position 4 up to position 15:</p>
<div class="sourceCode" id="cb12" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">dx</span><span class="op">,</span> <span class="kw">ax</span>        <span class="co">; make a copy of AX</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">and</span>   <span class="kw">al</span><span class="op">,</span> <span class="bn">00001111b</span> <span class="co">; clear bits 4-7</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="op">[</span>version<span class="op">],</span> <span class="kw">al</span> <span class="co">; store the result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Then, we extract <code>hdrlen</code> (header length) by shifting original <code>AX</code> to the right 4 bits and then mask off bits from position 4 up to 15:</p>
<div class="sourceCode" id="cb13" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ax</span><span class="op">,</span> <span class="kw">dx</span>        <span class="co">; restore original value</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">shr</span>   <span class="kw">ax</span><span class="op">,</span> <span class="dv">4</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">and</span>   <span class="kw">al</span><span class="op">,</span> <span class="bn">0000111b</span>  <span class="co">; clear bits 4-7</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="op">[</span>hdrlen<span class="op">],</span> <span class="kw">al</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Finally, we extract <code>tos</code> (type of service) by shifting original AX to the right 8 bits and then mask off bits from position 8 up to 15:</p>
<div class="sourceCode" id="cb14" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ax</span><span class="op">,</span> <span class="kw">dx</span>        <span class="co">; restore original value</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">shr</span>   <span class="kw">ax</span><span class="op">,</span> <span class="dv">8</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="op">[</span>tos<span class="op">],</span> <span class="kw">al</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Of course, we can simply assign <code>DH</code> directly to <code>[tos]</code> without shifting <code>AX</code> register. However, the purpose of the example is to show you how to extract data from a <strong>bit string</strong>.</p></li>
</ul></li>
</ol>
</section>
</section>
<section id="extended-addition-and-subtraction" class="level2">
<h2 class="anchored" data-anchor-id="extended-addition-and-subtraction">Extended Addition and Subtraction</h2>
<section id="adc-instruction" class="level3">
<h3 class="anchored" data-anchor-id="adc-instruction"><code>ADC</code> Instruction</h3>
<div class="callout callout-style-simple callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Syntax
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb15" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ADC</span>   <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>source<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li><p><code>ADC</code> (Add with Carry) instruction adds the destination operand, the source operand, and the CF flag and stores the result in the destination operand.</p></li>
<li><p>It performs the following operation: DEST = DEST + SRC + CF</p></li>
<li><p>The rules are similar to <code>ADD</code> rules.</p></li>
</ul>
</section>
<section id="sbb-instruction" class="level3">
<h3 class="anchored" data-anchor-id="sbb-instruction"><code>SBB</code> Instruction</h3>
<div class="callout callout-style-simple callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Syntax
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb16" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SBB</span>   <span class="op">&lt;</span>destination<span class="op">&gt;,</span> <span class="op">&lt;</span>source<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li><p><code>SBB</code> (Subtract with Borrow) instruction adds the source operand and the CF flag, and subtracts the result from the destination operand. The result of the subtraction is stored in the destination operand.</p></li>
<li><p>Operation: DEST = DEST - (SRC + CF)</p></li>
<li><p>The rules are similar to <code>ADD</code> rules.</p></li>
</ul>
</section>
<section id="flags-affected-3" class="level3">
<h3 class="anchored" data-anchor-id="flags-affected-3">Flags Affected</h3>
<p>All flags are set according to the result.</p>
</section>
<section id="examples-1" class="level3">
<h3 class="anchored" data-anchor-id="examples-1">Examples</h3>
<div id="exm-11" class="theorem example">
<p><span class="theorem-title"><strong>Example 7</strong></span> The following instructions add two 8-bit integers (FFh + FFh), producing a 16-bit sum in <code>DL:AL</code>, which is 01FEh.</p>
<div class="sourceCode" id="cb17" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>     <span class="kw">dl</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>     <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span><span class="er">FFh</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">add</span>     <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span><span class="er">FFh</span>      <span class="co">; AL=FFh + FFh = FEh, CF = 1</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">adc</span>     <span class="kw">dl</span><span class="op">,</span> <span class="dv">0</span>         <span class="co">; DL=1, CF=0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-12" class="theorem example">
<p><span class="theorem-title"><strong>Example 8</strong></span> This example demonstrates a technique of adding two numbers having unlimited size. In C++, for example, no standard operator permits you to add two 1024-bit integers.</p>
<p>Let us assume, we have two numbers <code>a</code> and <code>b</code> that store their numbers as array of bytes of size <code>n.</code> The least significant byte is stored at index 0, and the most significant byte is stored at index <code>n-1</code>. The following diagram shows how to add two numbers (4-byte) and store the result in array <code>s (5-byte)</code>.</p>
<div id="fig-abc" class="quarto-float quarto-figure quarto-figure-center anchored" width="80%">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-abc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="..\images/ADC.png" id="fig-abc" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-abc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8
</figcaption>
</figure>
</div>
<p>Notice that the size of array <code>s</code> is <code>n+1</code>. The following code implements the <strong>extended</strong> addition:</p>
<div class="sourceCode" id="cb18" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">esi</span><span class="op">,</span> a      <span class="co">; ESI is pointing to array a</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">edi</span><span class="op">,</span> b      <span class="co">; EDI is pointing to array b</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ebx</span><span class="op">,</span> s      <span class="co">; EBX is pointing to array s</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ecx</span><span class="op">,</span> <span class="dv">128</span>    <span class="co">; a &amp; b are 1024-bit, s is 1032-bit</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span>       <span class="co">; set AL to zero</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">L1:</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">clc</span>               <span class="co">; set CF to 0</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">add</span>   <span class="kw">al</span><span class="op">,</span> <span class="op">[</span><span class="kw">esi</span><span class="op">]</span>   </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">adc</span>   <span class="kw">al</span><span class="op">,</span> <span class="op">[</span><span class="kw">edi</span><span class="op">]</span>   <span class="co">; AL = a[i] + b[i]</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="op">[</span><span class="kw">ebx</span><span class="op">],</span> <span class="kw">al</span>   <span class="co">; store result at s[i]</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span>       <span class="co">; reset AL</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">adc</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span>       <span class="co">; store CF to AL for next round</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">inc</span>   <span class="kw">esi</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">inc</span>   <span class="kw">edi</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">inc</span>   <span class="kw">ebx</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">loop</span>  L1</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="op">[</span><span class="kw">ebx</span><span class="op">],</span> <span class="kw">al</span>   <span class="co">; store last CF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="unpacked-and-packed-decimal-arithmetic" class="level2">
<h2 class="anchored" data-anchor-id="unpacked-and-packed-decimal-arithmetic">Unpacked and Packed Decimal Arithmetic</h2>
<ul>
<li><p>So far, we have studied arithmetic operations where the values are in binary representation. In this section, we study the IA-32’s support for Binary-Coded Decimal (BCD).</p></li>
<li><p>Recall that, in BCD, a decimal digit can be represented either as upacked BCD or packed BCD. Please refer to <a href="https://khalid-elbadawi.github.io/C404/lectures/lec01.html#integer-representations">Lecture 1</a>.</p></li>
<li><p>x86 architecture provides a set of instructions for BCD integers. Eventually, the <u>CPU always calculates in binary.</u> It supports BCD arithmetic by adjusting the binary result into a BCD value.</p></li>
<li><p>For example, if we need to add two BCD values 5 and 8, then,</p></li>
</ul>
<pre data-code-line-numbers=""><code>-   We first add them by using the binary addition instruction, such as `ADD` .

    ``` nasm
          mov   ax, 5     ; AX = 0005h
          add   ax, 8     ; AX = 000Dh
    ```

-   Then, the CPU has an instruction to convert the result `000Dh` to unpacked (i.e., `AX = 0103`) or packed (i.e., `AX = 0013`) BCD.</code></pre>
<ul>
<li><p>Here are the list of instructions that support BCD conversions:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Mnemonic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>AAA</code></td>
<td>ASCII adjust after addition for unpacked BCD</td>
</tr>
<tr class="even">
<td><code>AAS</code></td>
<td>ASCII adjust after subtraction for unpacked BCD</td>
</tr>
<tr class="odd">
<td><code>AAM</code></td>
<td>ASCII adjust after multiplication for unpacked BCD</td>
</tr>
<tr class="even">
<td><code>AAD</code></td>
<td>ASCII adjust before division for unpacked BCD</td>
</tr>
<tr class="odd">
<td><code>DAA</code></td>
<td>Decimal adjust after addition for packed BCD</td>
</tr>
<tr class="even">
<td><code>DAS</code></td>
<td>Decimal adjust after subtraction for packed BCD</td>
</tr>
</tbody>
</table></li>
<li><p>These instructions have no operand. The destination operand is implied either <code>AL</code> or <code>AX</code> register.</p></li>
<li><p>In 64-bit mode, these instructions are not accessible.</p></li>
</ul>
<section id="aaa-instruction" class="level3">
<h3 class="anchored" data-anchor-id="aaa-instruction"><code>AAA</code> Instruction</h3>
<ul>
<li><p>This instruction adjusts the sum of two unpacked BCD values to create an unpacked BCD result.</p></li>
<li><p>The AL register is the implied source and destination operand.</p></li>
<li><p>If the adjustment produces a decimal carry, the AH register is incremented by 1, and CF and AF flags are set.</p></li>
</ul>
<div id="exm-21" class="theorem example">
<p><span class="theorem-title"><strong>Example 9</strong></span> Consider the following code:</p>
<div class="sourceCode" id="cb20" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ah</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">4</span>     <span class="co">; AX = 0004h</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">add</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">7</span>     <span class="co">; AX = 000Bh</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">aaa</span>             <span class="co">; AX = 0101h</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="exm-22" class="theorem example">
<p><span class="theorem-title"><strong>Example 10</strong></span> We can also add two ASCII digits:</p>
<div class="sourceCode" id="cb21" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ah</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="st">'8'</span>     <span class="co">; AX = 0038h</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">add</span>   <span class="kw">al</span><span class="op">,</span> <span class="st">'2'</span>     <span class="co">; AX = 006Ah</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">aaa</span>               <span class="co">; AX = 0100h, CF=1, AF=1</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">or</span>    <span class="kw">ax</span><span class="op">,</span> <span class="bn">3030h</span>   <span class="co">; AX = 3130h = '10'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="flags-affected-4" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-4">Flags Affected</h4>
<ul>
<li><p>The <code>AF</code> and <code>CF</code> flags are set to 1 if the adjustment results in a decimal carry; otherwise they are set to 0.</p></li>
<li><p>The <code>OF</code>, <code>SF</code>, <code>ZF</code>, and <code>PF</code> flags are undefined.</p></li>
</ul>
</section>
</section>
<section id="daa-instruction" class="level3">
<h3 class="anchored" data-anchor-id="daa-instruction"><code>DAA</code> Instruction</h3>
<ul>
<li><p>This instruction adjusts the sum of two packed BCD values to create a packed BCD result.</p></li>
<li><p>The <code>AL</code> register is the implied source and destination operand.</p></li>
</ul>
<div id="exm-23" class="theorem example">
<p><span class="theorem-title"><strong>Example 11</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb22" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">add</span>   <span class="kw">al</span><span class="op">,</span> <span class="kw">bl</span>    <span class="co">; before AL=79h, BL=35h</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                      <span class="co">; after  AL=AEh, BL=35h CF=0</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">daa</span>             <span class="co">; AL=14h, CF=1, AF=1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="flags-affected-5" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-5">Flags Affected</h4>
<ul>
<li><p>The <code>CF</code> and <code>AF</code> flags are set if the adjustment of the value results in a decimal carry in either digit of the result.</p></li>
<li><p>The <code>SF</code>, <code>ZF</code>, and <code>PF</code> flags are set according to the result.</p></li>
<li><p>The <code>OF</code> flag is undefined.</p></li>
</ul>
</section>
</section>
<section id="aas-instruction" class="level3">
<h3 class="anchored" data-anchor-id="aas-instruction"><code>AAS</code> Instruction</h3>
<ul>
<li><p>This instruction adjusts the result of the subtraction of two unpacked BCD values to create an unpacked BCD result.</p></li>
<li><p>The AL is the implied source and destination operand.</p></li>
<li><p>If the adjustment produces a decimal carry, the AH register is decremented by 1, and <code>CF</code> and <code>AF</code> flags are set.</p></li>
</ul>
<section id="flags-affected-6" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-6">Flags Affected</h4>
<ul>
<li>Similar to <code>AAA</code> instruction</li>
</ul>
</section>
</section>
<section id="das-instruction" class="level3">
<h3 class="anchored" data-anchor-id="das-instruction"><code>DAS</code> Instruction</h3>
<ul>
<li><p>This instruction adjusts the result of subtraction of two packed BCD values to create a packed BCD result.</p></li>
<li><p>The AL register is the implied and destination operand.</p></li>
</ul>
<section id="flags-affected-7" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-7">Flags Affected</h4>
<ul>
<li>Similar to <code>DAA</code> instruction.</li>
</ul>
</section>
</section>
<section id="aam-instruction" class="level3">
<h3 class="anchored" data-anchor-id="aam-instruction"><code>AAM</code> Instruction</h3>
<ul>
<li><p>This instruction adjusts the result of multiplying two unpacked BCD values to create a pair of unpacked BCD values.</p></li>
<li><p>The <code>AX</code> register is the implied source and destination operand.</p></li>
</ul>
<div id="exm-24" class="theorem example">
<p><span class="theorem-title"><strong>Example 12</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb23" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">al</span><span class="op">,</span> <span class="dv">8</span>   <span class="co">; AL=8h</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">2</span>   <span class="co">; BL=2h</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mul</span>   <span class="kw">bl</span>      <span class="co">; AX=10h</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">aam</span>           <span class="co">; AX=0106h</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="flags-affected-8" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-8">Flags Affected</h4>
<ul>
<li><p><code>CF</code> , <code>OF</code>, and <code>AF</code> flags are undefined.</p></li>
<li><p>The <code>SF</code>, <code>ZF</code>, and <code>PF</code> flags are set according to the value in the <code>AL</code>.</p></li>
</ul>
</section>
</section>
<section id="aad-instruction" class="level3">
<h3 class="anchored" data-anchor-id="aad-instruction"><code>AAD</code> Instruction</h3>
<ul>
<li><p>This instruction is different from the previous instructions. It adjusts two unpacked BCD digits stored in <code>AX</code> register to create a dividend value in binary format. Thus, when <code>DIV</code> is performed on the result, it will yield a correct unpacked BCD results.</p></li>
<li><p>The <code>AX</code> register is the implied source and destination operand.</p></li>
</ul>
<div id="exm-25" class="theorem example">
<p><span class="theorem-title"><strong>Example 13</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb24" data-code-line-numbers=""><pre class="sourceCode nasm code-with-copy"><code class="sourceCode nasm"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">ax</span><span class="op">,</span> <span class="bn">0307h</span>   <span class="co">; dividend = decimal 37</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">aad</span>               <span class="co">; AX = 0025h</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mov</span>   <span class="kw">bl</span><span class="op">,</span> <span class="dv">5</span>       <span class="co">; divisor</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">div</span>   <span class="kw">bl</span>          <span class="co">; AX = 0207h</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                        <span class="co">; quotient in AL</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                        <span class="co">; remainder in AH</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>AAD</code> instruction eventually sets the value in the <code>AL</code> register to <code>(AL + (10*AH))</code>, and then clears the <code>AH</code> register to <code>00H</code>.</li>
</ul>
<section id="flags-affected-9" class="level4">
<h4 class="anchored" data-anchor-id="flags-affected-9">Flags Affected</h4>
<ul>
<li>Similar to <code>AAM</code>.</li>
</ul>
</section>
</section>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>This example represents a complete assembly program that shows how to add two ASCII decimal values. The implementation is similar to <a href="#exm-12" class="quarto-xref">Example&nbsp;8</a>, in which the carry from each digit addition is propagated to the next higher position.</p>
<div class="sourceCode" id="cb25" data-code-line-numbers=""><pre class="sourceCode numberSource nasm number-lines code-with-copy"><code class="sourceCode nasm"><span id="cb25-1"><a href="#cb25-1"></a>            <span class="kw">global</span> _main</span>
<span id="cb25-2"><a href="#cb25-2"></a>            <span class="kw">extern</span> _printf</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a>DECIMALSZ   <span class="dt">EQU</span>     <span class="dv">10</span></span>
<span id="cb25-5"><a href="#cb25-5"></a></span>
<span id="cb25-6"><a href="#cb25-6"></a>            <span class="kw">section</span> <span class="fu">.data</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>d1          <span class="dt">db</span>      <span class="st">"1234567890"</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>d2          <span class="dt">db</span>      <span class="st">"7856341289"</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>prt_fmt     <span class="dt">db</span>      <span class="st">`  %10s</span><span class="ch">\n</span><span class="st">+ %10s</span><span class="ch">\n</span><span class="st">------------</span><span class="ch">\n</span><span class="st"> %11s</span><span class="ch">\n</span><span class="st">`</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>            <span class="kw">section</span> <span class="fu">.bss</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>d3          <span class="dt">resb</span>    DECIMALSZ<span class="op">+</span><span class="dv">2</span></span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a>            <span class="kw">section</span> <span class="fu">.code</span></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="fu">_main:</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>            <span class="kw">mov</span>     <span class="kw">esi</span><span class="op">,</span> DECIMALSZ<span class="op">-</span><span class="dv">1</span>    <span class="co">; Set Index to Last Decimal</span></span>
<span id="cb25-16"><a href="#cb25-16"></a>            <span class="kw">mov</span>     <span class="kw">ax</span><span class="op">,</span> <span class="dv">0</span>               <span class="co">; clear AL and AH</span></span>
<span id="cb25-17"><a href="#cb25-17"></a>            <span class="kw">mov</span>     <span class="kw">ecx</span><span class="op">,</span> DECIMALSZ      <span class="co">; set loop counter to DECIMALSZ</span></span>
<span id="cb25-18"><a href="#cb25-18"></a><span class="fu">top1:</span></span>
<span id="cb25-19"><a href="#cb25-19"></a>            <span class="kw">add</span>     <span class="kw">al</span><span class="op">,</span> <span class="op">[</span>d1 <span class="op">+</span> <span class="kw">esi</span><span class="op">]</span>      <span class="co">; AL = Carry + d1[i]</span></span>
<span id="cb25-20"><a href="#cb25-20"></a>            <span class="kw">add</span>     <span class="kw">al</span><span class="op">,</span> <span class="op">[</span>d2 <span class="op">+</span> <span class="kw">esi</span><span class="op">]</span>      <span class="co">; AL = AL + d2[i]</span></span>
<span id="cb25-21"><a href="#cb25-21"></a>            <span class="kw">aaa</span>                         <span class="co">; adjust to unpacked BCD</span></span>
<span id="cb25-22"><a href="#cb25-22"></a>            <span class="kw">or</span>      <span class="kw">al</span><span class="op">,</span> <span class="bn">30h</span>             <span class="co">; covert AL to ASCII</span></span>
<span id="cb25-23"><a href="#cb25-23"></a>            <span class="kw">push</span>    <span class="kw">ax</span>                  <span class="co">; store result into stack</span></span>
<span id="cb25-24"><a href="#cb25-24"></a>            <span class="kw">mov</span>     <span class="kw">al</span><span class="op">,</span> <span class="kw">ah</span>              <span class="co">; store Carry into AL</span></span>
<span id="cb25-25"><a href="#cb25-25"></a>            <span class="kw">mov</span>     <span class="kw">ah</span><span class="op">,</span> <span class="dv">0</span>               <span class="co">; clear AH</span></span>
<span id="cb25-26"><a href="#cb25-26"></a>            <span class="kw">dec</span>     <span class="kw">esi</span>                 <span class="co">; move ESI to next highest position</span></span>
<span id="cb25-27"><a href="#cb25-27"></a>            <span class="kw">loop</span>    top1</span>
<span id="cb25-28"><a href="#cb25-28"></a>          </span>
<span id="cb25-29"><a href="#cb25-29"></a>            <span class="co">; the number of elements pushed onto stack is DECIMALSZ</span></span>
<span id="cb25-30"><a href="#cb25-30"></a>            <span class="kw">mov</span>     <span class="kw">ecx</span><span class="op">,</span> DECIMALSZ</span>
<span id="cb25-31"><a href="#cb25-31"></a></span>
<span id="cb25-32"><a href="#cb25-32"></a>            <span class="co">; Check if there is a carry out of the highest position</span></span>
<span id="cb25-33"><a href="#cb25-33"></a>            <span class="kw">cmp</span>     <span class="kw">al</span><span class="op">,</span> <span class="dv">0</span>               <span class="co">; if AL == 0h</span></span>
<span id="cb25-34"><a href="#cb25-34"></a>            <span class="cf">je</span>      done                <span class="co">; jump if no carry</span></span>
<span id="cb25-35"><a href="#cb25-35"></a>            <span class="kw">or</span>      <span class="kw">al</span><span class="op">,</span> <span class="bn">30h</span>             <span class="co">; convert to ASCII</span></span>
<span id="cb25-36"><a href="#cb25-36"></a>            <span class="kw">push</span>    <span class="kw">ax</span>                  <span class="co">; store onto stack</span></span>
<span id="cb25-37"><a href="#cb25-37"></a>            <span class="kw">inc</span>     <span class="kw">ecx</span>                 <span class="co">; add one element </span></span>
<span id="cb25-38"><a href="#cb25-38"></a><span class="fu">done:</span></span>
<span id="cb25-39"><a href="#cb25-39"></a>            <span class="co">; now move result from stack into d3</span></span>
<span id="cb25-40"><a href="#cb25-40"></a>            <span class="kw">mov</span>     <span class="kw">esi</span><span class="op">,</span> <span class="dv">0</span>            </span>
<span id="cb25-41"><a href="#cb25-41"></a><span class="fu">top2:</span></span>
<span id="cb25-42"><a href="#cb25-42"></a>            <span class="kw">pop</span>     <span class="kw">ax</span></span>
<span id="cb25-43"><a href="#cb25-43"></a>            <span class="kw">mov</span>     <span class="op">[</span><span class="kw">esi</span> <span class="op">+</span> d3<span class="op">],</span> <span class="kw">al</span></span>
<span id="cb25-44"><a href="#cb25-44"></a>            <span class="kw">inc</span>     <span class="kw">esi</span></span>
<span id="cb25-45"><a href="#cb25-45"></a>            <span class="kw">loop</span>    top2</span>
<span id="cb25-46"><a href="#cb25-46"></a></span>
<span id="cb25-47"><a href="#cb25-47"></a>            <span class="kw">mov</span>     <span class="dt">BYTE</span> <span class="op">[</span><span class="kw">esi</span> <span class="op">+</span> d3<span class="op">],</span> <span class="dv">0</span>  <span class="co">; insert null-character</span></span>
<span id="cb25-48"><a href="#cb25-48"></a>            <span class="co">; prints out the result</span></span>
<span id="cb25-49"><a href="#cb25-49"></a>            <span class="kw">push</span>    d3</span>
<span id="cb25-50"><a href="#cb25-50"></a>            <span class="kw">push</span>    d2</span>
<span id="cb25-51"><a href="#cb25-51"></a>            <span class="kw">push</span>    d1</span>
<span id="cb25-52"><a href="#cb25-52"></a>            <span class="kw">push</span>    prt_fmt</span>
<span id="cb25-53"><a href="#cb25-53"></a>            <span class="cf">call</span>    _printf</span>
<span id="cb25-54"><a href="#cb25-54"></a>            <span class="kw">add</span>     <span class="kw">esp</span><span class="op">,</span> <span class="dv">16</span></span>
<span id="cb25-55"><a href="#cb25-55"></a></span>
<span id="cb25-56"><a href="#cb25-56"></a>            <span class="kw">xor</span>     <span class="kw">eax</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb25-57"><a href="#cb25-57"></a>            <span class="cf">ret</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here is the output:</p>
<p><img src="..\images/sample_lec6.png" class="img-fluid"></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/khalid-elbadawi\.github\.io\/C404\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>